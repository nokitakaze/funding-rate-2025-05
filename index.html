<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Prices & Funding</title>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <style>
        #graph {
            height: 90vh;
            min-width: 310px;
        }
    </style>
</head>
<body>
<div id="graph"></div>

<script type="module">
    async function load(p) {
        const r = await fetch(p);
        if (!r.ok) {
            throw new Error(`Не удалось загрузить ${p}`);
        }
        return r.json();
    }

    const toSeriesPrice = (a, i) => a
        .map(d => [d[0] * 1000, d[i] ?? null])
        .filter(d => d[1] !== null);
    const toSeriesFunding = (a, i) => a
        .map(d => [d[0] * 1000, d[i] != null ? d[i] * 100 : null]);

    (async () => {
        const [btc, eth, sol] = await Promise.all(['data-BTC.json', 'data-ETH.json', 'data-SOL.json'].map(load));

        Highcharts.stockChart('graph', {
            rangeSelector: {selected: 1},
            title: {text: 'Цены и ставки фандинга'},
            legend: {enabled: true},
            yAxis: [{
                title: {text: 'Funding, %'},
                labels: {format: '{value:.4f}%'}
            }, {
                title: {text: 'Price, USD'},
                opposite: true,
                labels: {format: '${value:.2f}'}
            }],
            tooltip: {shared: true},
            series: [
                {name: 'BTC Price', data: toSeriesPrice(btc, 1), yAxis: 1, connectNulls: true, tooltip: {valueDecimals: 2}},
                {name: 'ETH Price', data: toSeriesPrice(eth, 1), yAxis: 1, connectNulls: true, tooltip: {valueDecimals: 2}},
                {name: 'SOL Price', data: toSeriesPrice(sol, 1), yAxis: 1, connectNulls: true, tooltip: {valueDecimals: 2}},

                {
                    name: 'BTC Funding Binance', data: toSeriesFunding(btc, 2), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                },
                {
                    name: 'BTC Funding Bybit', data: toSeriesFunding(btc, 3), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                },
                {
                    name: 'ETH Funding Binance', data: toSeriesFunding(eth, 2), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                },
                {
                    name: 'ETH Funding Bybit', data: toSeriesFunding(eth, 3), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                },
                {
                    name: 'SOL Funding Binance', data: toSeriesFunding(sol, 2), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                },
                {
                    name: 'SOL Funding Bybit', data: toSeriesFunding(sol, 3), yAxis: 0, connectNulls: true,
                    tooltip: {valueDecimals: 4, valueSuffix: '%'}
                }
            ]
        });
    })().catch(console.error);
</script>
</body>
</html>
